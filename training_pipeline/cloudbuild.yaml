steps:
  # Build the component of the Kubeflow Pipeline
  # The name is the URI of the corresponding cloud builder container
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', '$_DOCKER_CONTAINER_REGISTRY_BASE_URL/$_PROJECT_NAME/$_DATA_INGESTION:$SHORT_SHA', '.']
    dir: $_COMPONENTS_FOLDER/$_DATA_INGESTION

  # Build the component of the Kubeflow Pipeline
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', '$_DOCKER_CONTAINER_REGISTRY_BASE_URL/$_PROJECT_NAME/$_DATA_PREPARATION:$SHORT_SHA', '.']
    dir: $_COMPONENTS_FOLDER/$_DATA_PREPARATION

  # Build the component of the Kubeflow Pipeline
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', '$_DOCKER_CONTAINER_REGISTRY_BASE_URL/$_PROJECT_NAME/$_RANDOM_FOREST_REGRESSOR_TRAINING:$SHORT_SHA', '.']
    env:
      - 'MLFLOW_TRACKING_URI=$_MLFLOW_TRACKING_URI'
    dir: $_COMPONENTS_FOLDER/$_RANDOM_FOREST_REGRESSOR_TRAINING

  # Build the component of the Kubeflow Pipeline
  - name: 'gcr.io/cloud-builders/docker'
    args: [ 'build', '-t', '$_DOCKER_CONTAINER_REGISTRY_BASE_URL/$_PROJECT_NAME/$_LINEAR_REGRESSION_TRAINING:$SHORT_SHA', '.' ]
    env:
      - 'MLFLOW_TRACKING_URI=$_MLFLOW_TRACKING_URI'
    dir: $_COMPONENTS_FOLDER/$_LINEAR_REGRESSION_TRAINING

  # Build the component of the Kubeflow Pipeline
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', '$_DOCKER_CONTAINER_REGISTRY_BASE_URL/$_PROJECT_NAME/$_PROMOTE_MODEL:$SHORT_SHA', '.']
    env:
      - 'MLFLOW_TRACKING_URI=$_MLFLOW_TRACKING_URI'
    dir: $_COMPONENTS_FOLDER/$_PROMOTE_MODEL

  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', '$_DOCKER_CONTAINER_REGISTRY_BASE_URL/$_PROJECT_NAME/kfp-cli:latest', '.']
    env:
      - 'MLFLOW_TRACKING_URI=$_MLFLOW_TRACKING_URI'
    dir: $_PIPELINE_FOLDER


# In the args property we build the image locally. We also need to push the built image to a docker container registry.
# This operation is specified in the 'images' property.
# Note the lowercase name ('images')
images:
  - '$_DOCKER_CONTAINER_REGISTRY_BASE_URL/$_PROJECT_NAME/$_DATA_INGESTION:$SHORT_SHA'
  - '$_DOCKER_CONTAINER_REGISTRY_BASE_URL/$_PROJECT_NAME/$_DATA_PREPARATION:$SHORT_SHA'
  - '$_DOCKER_CONTAINER_REGISTRY_BASE_URL/$_PROJECT_NAME/$_LINEAR_REGRESSION_TRAINING:$SHORT_SHA'
  - '$_DOCKER_CONTAINER_REGISTRY_BASE_URL/$_PROJECT_NAME/$_RANDOM_FOREST_REGRESSOR_TRAINING:$SHORT_SHA'
  - '$_DOCKER_CONTAINER_REGISTRY_BASE_URL/$_PROJECT_NAME/$_PROMOTE_MODEL:$SHORT_SHA'
  - '$_DOCKER_CONTAINER_REGISTRY_BASE_URL/$_PROJECT_NAME/kfp-cli:latest'
timeout: 900s
